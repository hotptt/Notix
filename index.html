<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upbit 알림 등록 (봇 토큰 · 채널 ID)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif;background:#f7f7fb;margin:0;color:#111}
    .wrap{max-width:720px;margin:32px auto;background:#fff;padding:24px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    h1{margin:0 0 16px;font-size:22px}
    label{display:block;margin:12px 0 6px;color:#374151;font-size:14px}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
    button{margin-top:16px;padding:12px 16px;border:0;border-radius:12px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;padding:12px;border-radius:10px;margin-top:12px;display:none}
    .err{background:#fff1f2;color:#9f1239;border:1px solid #fecdd3;padding:12px;border-radius:12px;margin-top:12px;display:none}
    .note{font-size:13px;color:#6b7280;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upbit 알림 등록 (봇 토큰 · 채널 ID)</h1>
    <p class="note">봇을 서버에 초대하고, <b>채널 ID</b>를 입력하세요. 폼 제출 후 서버(DB)에 저장되며, 임계 진입 시 봇이 해당 채널로 알림을 보냅니다.</p>
    <form id="f">
      <label>코인 (KRW- 마켓)</label>
      <select id="market" required><option value="">불러오는 중...</option></select>

      <div class="grid">
        <div>
          <label>평단가(원)</label>
          <input id="avg" type="number" min="0" step="0.0001" placeholder="50000000" required>
        </div>
        <div>
          <label>채널 ID (숫자)</label>
          <input id="chan" type="text" placeholder="예: 123456789012345678" required>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>상승 임계값(%)</label>
          <input id="up" type="number" step="0.01" value="2.0" required>
        </div>
        <div>
          <label>하락 임계값(%)</label>
          <input id="down" type="number" step="0.01" value="-2.0" required>
        </div>
      </div>
      <button type="submit">등록/수정</button>
    </form>
    <div class="ok" id="ok">✅ 등록/수정 완료! 임계 진입 시 봇이 채널로 알림을 보냅니다.</div>
    <div class="err" id="err">❌ 오류가 발생했어요.</div>
    <p class="note">* 채널 ID 확인: 디스코드 설정 → 고급 → 개발자 모드 ON → 채널 우클릭 → ID 복사</p>
  </div>

<script>
async function loadMarkets(){
  const sel = document.getElementById('market');
  sel.innerHTML = '<option value="">불러오는 중...</option>';
  try{
    const res = await fetch('/api/markets');
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const data = await res.json();
    sel.innerHTML = '<option value="">코인을 선택하세요</option>';
    for(const it of data){
      const opt = document.createElement('option');
      opt.value = it.market;
      opt.textContent = `${it.market} · ${it.name}`;
      sel.appendChild(opt);
    }
  }catch(e){
    sel.innerHTML = '<option value="">목록 불러오기 실패</option>';
    console.error('markets error:', e);
  }
}

async function submitForm(e){
  e.preventDefault();
  const ok = document.getElementById('ok');
  const err = document.getElementById('err');
  ok.style.display = 'none'; err.style.display = 'none';

  const payload = {
    market: document.getElementById('market').value,
    avg_price: parseFloat(document.getElementById('avg').value),
    up_threshold: parseFloat(document.getElementById('up').value),
    down_threshold: parseFloat(document.getElementById('down').value),
    channel_id: document.getElementById('chan').value.trim()
  };

  try{
    const res = await fetch('/api/track', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error('HTTP '+res.status+' '+txt);
    }
    ok.style.display='block';
  }catch(e){
    console.error('submit error:', e);
    err.style.display='block';
  }
}

document.getElementById('f').addEventListener('submit', submitForm);
loadMarkets();
</script>
</body>
</html>